<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NSUK Confessions ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0f; --surface:#13131a; --surface2:#1c1c28;
    --border:rgba(255,255,255,0.07); --accent1:#c084fc; --accent2:#f472b6;
    --red:#f87171; --green:#4ade80; --yellow:#fbbf24;
    --text:#f1f0f5; --muted:#8b8a9e;
    --grad:linear-gradient(135deg,#c084fc,#f472b6);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; }
  body::before { content:''; position:fixed; top:-200px; left:50%; transform:translateX(-50%); width:700px; height:700px; background:radial-gradient(circle,rgba(192,132,252,0.1) 0%,transparent 70%); pointer-events:none; z-index:0; }

  #loginPage { position:fixed; inset:0; z-index:999; display:flex; align-items:center; justify-content:center; background:var(--bg); padding:24px; }
  .login-box { background:var(--surface); border:1px solid var(--border); border-radius:24px; padding:40px 32px; width:100%; max-width:400px; text-align:center; }
  .login-logo { font-family:'Syne',sans-serif; font-weight:800; font-size:1.3rem; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px; }
  .login-sub { color:var(--muted); font-size:0.85rem; margin-bottom:32px; }
  .login-box input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.95rem; padding:13px 16px; outline:none; transition:border-color .2s; margin-bottom:12px; display:block; }
  .login-box input:focus { border-color:var(--accent1); }
  .login-box input::placeholder { color:var(--muted); }
  .login-btn { width:100%; background:var(--grad); border:none; color:#fff; font-family:'DM Sans',sans-serif; font-weight:600; font-size:1rem; padding:13px; border-radius:12px; cursor:pointer; transition:opacity .2s; margin-top:4px; }
  .login-btn:hover { opacity:.85; }
  .login-btn:disabled { opacity:.5; cursor:not-allowed; }
  .login-error { color:var(--red); font-size:0.85rem; margin-top:12px; display:none; }

  #adminPage { display:none; min-height:100vh; }
  .admin-nav { position:sticky; top:0; z-index:100; padding:14px 24px; background:rgba(10,10,15,0.9); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .admin-logo { font-family:'Syne',sans-serif; font-weight:800; font-size:1rem; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .admin-logo span { -webkit-text-fill-color:var(--muted); background:none; font-weight:400; font-size:.85rem; }
  .logout-btn { background:rgba(248,113,113,0.15); border:1px solid rgba(248,113,113,0.25); color:var(--red); font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:600; padding:7px 16px; border-radius:50px; cursor:pointer; transition:background .2s; }
  .logout-btn:hover { background:rgba(248,113,113,0.25); }

  /* APPROVAL TOGGLE */
  .approval-banner { max-width:900px; margin:20px auto 0; padding:0 24px; position:relative; z-index:1; }
  .approval-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .approval-info h3 { font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700; margin-bottom:4px; }
  .approval-info p { font-size:0.78rem; color:var(--muted); }
  .toggle-wrap { display:flex; align-items:center; gap:10px; }
  .toggle-label { font-size:0.82rem; color:var(--muted); }
  .toggle { position:relative; width:48px; height:26px; }
  .toggle input { opacity:0; width:0; height:0; }
  .toggle-slider { position:absolute; inset:0; background:var(--surface2); border-radius:50px; cursor:pointer; transition:.3s; border:1px solid var(--border); }
  .toggle-slider:before { content:''; position:absolute; width:18px; height:18px; left:3px; bottom:3px; background:var(--muted); border-radius:50%; transition:.3s; }
  .toggle input:checked + .toggle-slider { background:rgba(192,132,252,0.3); border-color:var(--accent1); }
  .toggle input:checked + .toggle-slider:before { transform:translateX(22px); background:var(--accent1); }
  .approval-status { font-size:0.78rem; font-weight:600; padding:4px 12px; border-radius:50px; }
  .approval-status.on { background:rgba(192,132,252,0.15); color:var(--accent1); border:1px solid rgba(192,132,252,0.3); }
  .approval-status.off { background:rgba(74,222,128,0.1); color:var(--green); border:1px solid rgba(74,222,128,0.25); }

  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; padding:20px 24px; max-width:900px; margin:0 auto; position:relative; z-index:1; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:16px; text-align:center; }
  .stat-num { font-family:'Syne',sans-serif; font-size:1.8rem; font-weight:800; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .stat-num.pending-num { background:linear-gradient(135deg,#fbbf24,#f87171); -webkit-background-clip:text; }
  .stat-label { color:var(--muted); font-size:0.72rem; margin-top:4px; }

  .tabs { display:flex; gap:8px; padding:0 24px 20px; max-width:900px; margin:0 auto; position:relative; z-index:1; flex-wrap:wrap; }
  .tab { background:var(--surface); border:1px solid var(--border); color:var(--muted); font-family:'DM Sans',sans-serif; font-size:0.85rem; font-weight:500; padding:8px 20px; border-radius:50px; cursor:pointer; transition:all .2s; }
  .tab.active { background:var(--grad); border-color:transparent; color:#fff; }
  .tab .tab-count { background:rgba(255,255,255,0.2); border-radius:50px; padding:1px 7px; font-size:0.72rem; margin-left:4px; }

  .admin-content { max-width:900px; margin:0 auto; padding:0 24px 80px; position:relative; z-index:1; }
  .search-bar { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.9rem; padding:12px 16px; outline:none; transition:border-color .2s; margin-bottom:20px; display:block; }
  .search-bar:focus { border-color:var(--accent1); }
  .search-bar::placeholder { color:var(--muted); }

  .admin-card { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:18px; margin-bottom:12px; animation:fadeUp .3s ease both; }
  .admin-card.pending-card { border-color:rgba(251,191,36,0.3); background:rgba(251,191,36,0.04); }
  .admin-card.hidden-card { opacity:0.6; border-style:dashed; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .admin-card-meta { font-size:0.78rem; color:var(--muted); margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  .admin-card-text { font-size:0.92rem; line-height:1.6; color:var(--text); margin-bottom:10px; white-space:pre-wrap; word-break:break-word; }
  .admin-card-footer { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .meta-pill { background:var(--surface2); border:1px solid var(--border); border-radius:50px; font-size:0.72rem; color:var(--muted); padding:3px 10px; }
  .meta-pill.pending { background:rgba(251,191,36,0.1); color:var(--yellow); border-color:rgba(251,191,36,0.3); }
  .meta-pill.hidden { background:rgba(248,113,113,0.1); color:var(--red); border-color:rgba(248,113,113,0.2); }
  .meta-pill.approved { background:rgba(74,222,128,0.1); color:var(--green); border-color:rgba(74,222,128,0.25); }

  .reactions-display { display:flex; flex-wrap:wrap; gap:5px; margin:8px 0; }
  .r-pill { display:flex; align-items:center; gap:3px; background:var(--surface2); border:1px solid var(--border); border-radius:50px; padding:3px 9px; font-size:0.8rem; }
  .r-pill .count { color:var(--muted); font-size:0.75rem; }

  .btn-danger { background:rgba(248,113,113,0.12); border:1px solid rgba(248,113,113,0.25); color:var(--red); font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 14px; border-radius:50px; cursor:pointer; transition:background .2s; white-space:nowrap; }
  .btn-danger:hover { background:rgba(248,113,113,0.25); }
  .btn-approve { background:rgba(74,222,128,0.12); border:1px solid rgba(74,222,128,0.25); color:var(--green); font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 14px; border-radius:50px; cursor:pointer; transition:background .2s; white-space:nowrap; }
  .btn-approve:hover { background:rgba(74,222,128,0.22); }
  .btn-hide { background:rgba(251,191,36,0.12); border:1px solid rgba(251,191,36,0.25); color:var(--yellow); font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 14px; border-radius:50px; cursor:pointer; transition:background .2s; white-space:nowrap; }
  .btn-hide:hover { background:rgba(251,191,36,0.22); }
  .btn-block { background:rgba(251,191,36,0.12); border:1px solid rgba(251,191,36,0.25); color:var(--yellow); font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 14px; border-radius:50px; cursor:pointer; transition:background .2s; white-space:nowrap; }
  .btn-block:hover { background:rgba(251,191,36,0.22); }
  .btn-unblock { background:rgba(74,222,128,0.12); border:1px solid rgba(74,222,128,0.25); color:var(--green); font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 14px; border-radius:50px; cursor:pointer; transition:background .2s; white-space:nowrap; }
  .btn-unblock:hover { background:rgba(74,222,128,0.22); }
  .btn-expand { background:var(--surface2); border:1px solid var(--border); color:var(--muted); font-family:'DM Sans',sans-serif; font-size:0.78rem; padding:6px 14px; border-radius:50px; cursor:pointer; transition:color .2s; }
  .btn-expand:hover { color:var(--text); }

  .comments-panel { margin-top:14px; padding-top:14px; border-top:1px solid var(--border); display:none; }
  .comments-panel.open { display:block; }
  .comment-row { background:var(--surface2); border-radius:10px; padding:10px 12px; margin-bottom:8px; }
  .comment-row-meta { font-size:0.72rem; color:var(--muted); margin-bottom:4px; }
  .comment-row-top { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
  .comment-row-text { font-size:0.85rem; line-height:1.5; flex:1; margin-bottom:6px; white-space:pre-wrap; word-break:break-word; }
  .comment-row-actions { display:flex; gap:6px; flex-shrink:0; }

  .blocked-card { background:var(--surface); border:1px solid rgba(248,113,113,0.2); border-radius:14px; padding:16px 18px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .blocked-ip { font-size:0.9rem; font-family:monospace; color:var(--red); }
  .blocked-meta { font-size:0.75rem; color:var(--muted); margin-top:2px; }

  .loading { text-align:center; padding:50px 20px; color:var(--muted); }
  .spinner { width:32px; height:32px; border-radius:50%; border:3px solid var(--surface2); border-top-color:var(--accent1); animation:spin .7s linear infinite; margin:0 auto 14px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .empty { text-align:center; padding:50px 20px; color:var(--muted); font-size:0.9rem; }

  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--surface2); border:1px solid rgba(192,132,252,0.3); color:var(--text); font-size:.85rem; padding:11px 22px; border-radius:50px; z-index:9999; transition:transform .3s ease; white-space:nowrap; }
  .toast.show { transform:translateX(-50%) translateY(0); }

  .confirm-backdrop { display:none; position:fixed; inset:0; z-index:500; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); align-items:center; justify-content:center; padding:20px; }
  .confirm-backdrop.open { display:flex; }
  .confirm-box { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:28px; max-width:360px; width:100%; text-align:center; animation:modalIn .2s ease; }
  @keyframes modalIn { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }
  .confirm-box h3 { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:700; margin-bottom:10px; }
  .confirm-box p { color:var(--muted); font-size:0.88rem; line-height:1.6; margin-bottom:24px; white-space:pre-wrap; }
  .confirm-btns { display:flex; gap:10px; }
  .confirm-btns button { flex:1; padding:11px; border-radius:12px; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; border:none; transition:opacity .2s; }
  .confirm-cancel { background:var(--surface2); color:var(--muted); }
  .confirm-ok { background:linear-gradient(135deg,#f87171,#f472b6); color:#fff; }
  .confirm-cancel:hover,.confirm-ok:hover { opacity:.85; }
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--surface2); border-radius:4px; }
</style>
</head>
<body>

<div id="loginPage">
  <div class="login-box">
    <div class="login-logo">NSUK Confessions</div>
    <div class="login-sub">Admin Panel ‚Äî Authorized Access Only üîê</div>
    <input type="email" id="loginEmail" placeholder="Admin Email" autocomplete="email">
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" id="loginBtn" onclick="doLogin()">Login</button>
    <div class="login-error" id="loginError">Invalid credentials. Try again.</div>
  </div>
</div>

<div id="adminPage">
  <nav class="admin-nav">
    <div class="admin-logo">NSUK Confessions <span>¬∑ Admin</span></div>
    <button class="logout-btn" onclick="doLogout()">Logout</button>
  </nav>

  <!-- Approval Toggle -->
  <div class="approval-banner">
    <div class="approval-card">
      <div class="approval-info">
        <h3>üõ°Ô∏è Approval Mode</h3>
        <p>When ON, all new messages must be approved before appearing publicly.</p>
      </div>
      <div class="toggle-wrap">
        <span class="approval-status off" id="approvalStatus">OFF</span>
        <label class="toggle">
          <input type="checkbox" id="approvalToggle" onchange="toggleApproval()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card"><div class="stat-num" id="statTotal">‚Äî</div><div class="stat-label">Total</div></div>
    <div class="stat-card"><div class="stat-num pending-num" id="statPending">‚Äî</div><div class="stat-label">Pending</div></div>
    <div class="stat-card"><div class="stat-num" id="statComments">‚Äî</div><div class="stat-label">Comments</div></div>
    <div class="stat-card"><div class="stat-num" id="statBlocked">‚Äî</div><div class="stat-label">Blocked IPs</div></div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('approved',this)">‚úÖ Approved</button>
    <button class="tab" onclick="switchTab('pending',this)" id="pendingTab">‚è≥ Pending <span class="tab-count" id="pendingCount">0</span></button>
    <button class="tab" onclick="switchTab('hidden',this)">üôà Hidden</button>
    <button class="tab" onclick="switchTab('blocked',this)">üö´ Blocked IPs</button>
  </div>

  <div class="admin-content">
    <div id="tabApproved">
      <input class="search-bar" id="searchBar" placeholder="üîç Search messages..." oninput="filterConfessions()">
      <div id="confessionsList"><div class="loading"><div class="spinner"></div>Loading...</div></div>
    </div>
    <div id="tabPending" style="display:none;">
      <div id="pendingList"><div class="loading"><div class="spinner"></div>Loading...</div></div>
    </div>
    <div id="tabHidden" style="display:none;">
      <div id="hiddenList"><div class="loading"><div class="spinner"></div>Loading...</div></div>
    </div>
    <div id="tabBlocked" style="display:none;">
      <div id="blockedList"><div class="loading"><div class="spinner"></div>Loading...</div></div>
    </div>
  </div>
</div>

<div class="confirm-backdrop" id="confirmBackdrop">
  <div class="confirm-box">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmMsg">This action cannot be undone.</p>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-ok" id="confirmOkBtn">Confirm</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, deleteDoc,
    onSnapshot, orderBy, query, setDoc, serverTimestamp,
    writeBatch, updateDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyBoY8QFMH_-N6kPbvnxumcj3Aw2HJcaqm4",
    authDomain: "nsuk-confession.firebaseapp.com",
    projectId: "nsuk-confession",
    storageBucket: "nsuk-confession.firebasestorage.app",
    messagingSenderId: "824345455790",
    appId: "1:824345455790:web:40f6c244b2b85b9ea7513f"
  });

  const auth = getAuth(app);
  const db = getFirestore(app);
  const EMOJIS = ['üòÇ','üò°','üò≤','üò¢','üî•'];
  let allDocs = [];
  let confirmCb = null;
  let currentTab = 'approved';

  // Auto logout after 30 mins
  let inactivityTimer;
  function resetInactivity() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(()=>{ signOut(auth); showToast('Session expired.'); }, 30*60*1000);
  }
  ['click','keydown','mousemove','touchstart'].forEach(e=>document.addEventListener(e,resetInactivity));

  const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  function timeAgo(ts) {
    if(!ts) return '‚Äî';
    const d=ts.toDate?ts.toDate():new Date(ts), s=Math.floor((Date.now()-d)/1000);
    if(s<60) return 'just now'; if(s<3600) return Math.floor(s/60)+'m ago';
    if(s<86400) return Math.floor(s/3600)+'h ago'; return d.toLocaleDateString();
  }

  function buildReactionDisplay(reactions) {
    if(!reactions) return '';
    const pills = EMOJIS.filter(e=>(reactions[e]||0)>0)
      .map(e=>`<span class="r-pill">${e} <span class="count">${reactions[e]}</span></span>`).join('');
    return pills?`<div class="reactions-display">${pills}</div>`:'';
  }

  // Load approval setting
  async function loadApprovalSetting() {
    try {
      const snap = await getDoc(doc(db,'settings','moderation'));
      const on = snap.exists() && snap.data().approvalRequired === true;
      document.getElementById('approvalToggle').checked = on;
      updateApprovalStatus(on);
    } catch(e){}
  }

  function updateApprovalStatus(on) {
    const el = document.getElementById('approvalStatus');
    el.textContent = on ? 'ON' : 'OFF';
    el.className = 'approval-status ' + (on ? 'on' : 'off');
  }

  window.toggleApproval = async () => {
    const on = document.getElementById('approvalToggle').checked;
    try {
      await setDoc(doc(db,'settings','moderation'), { approvalRequired: on });
      updateApprovalStatus(on);
      showToast(on ? 'üõ°Ô∏è Approval mode ON' : '‚úÖ Approval mode OFF');
    } catch(e) { showToast('Error updating setting.'); }
  };

  onAuthStateChanged(auth, user=>{
    if(user){
      document.getElementById('loginPage').style.display='none';
      document.getElementById('adminPage').style.display='block';
      resetInactivity();
      loadData();
      loadApprovalSetting();
    } else {
      document.getElementById('loginPage').style.display='flex';
      document.getElementById('adminPage').style.display='none';
    }
  });

  window.doLogin = async()=>{
    const email=document.getElementById('loginEmail').value.trim();
    const pass=document.getElementById('loginPass').value;
    const btn=document.getElementById('loginBtn');
    const err=document.getElementById('loginError');
    err.style.display='none'; btn.disabled=true; btn.textContent='Logging in...';
    try { await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ err.style.display='block'; btn.disabled=false; btn.textContent='Login'; }
  };

  window.doLogout=()=>signOut(auth);

  function loadData(){
    onSnapshot(query(collection(db,'confessions'),orderBy('createdAt','desc')),snap=>{
      allDocs=snap.docs;
      const approved = snap.docs.filter(d=>{ const s=d.data().status; return (s==='approved'||!s) && !d.data().hidden; });
      const pending = snap.docs.filter(d=>d.data().status==='pending');
      const hidden = snap.docs.filter(d=>d.data().hidden===true);
      document.getElementById('statTotal').textContent=approved.length;
      document.getElementById('statPending').textContent=pending.length;
      document.getElementById('pendingCount').textContent=pending.length;
      let total=0; snap.docs.forEach(d=>total+=(d.data().commentCount||0));
      document.getElementById('statComments').textContent=total;
      renderConfessions(approved, 'confessionsList', false);
      renderConfessions(pending, 'pendingList', true);
      renderConfessions(hidden, 'hiddenList', false, true);
    });
    onSnapshot(collection(db,'blockedIPs'),snap=>{
      document.getElementById('statBlocked').textContent=snap.docs.length;
      renderBlocked(snap.docs);
    });
  }

  function renderConfessions(docs, containerId, isPending=false, isHidden=false){
    const el=document.getElementById(containerId);
    if(!docs.length){ el.innerHTML=`<div class="empty">${isPending?'No pending messages üéâ':isHidden?'No hidden messages':'No approved messages yet.'}</div>`; return; }
    el.innerHTML=docs.map((d,i)=>{
      const data=d.data(), ipSafe=data.ip?esc(data.ip):null;
      const statusPill = isPending
        ? `<span class="meta-pill pending">‚è≥ Pending</span>`
        : isHidden ? `<span class="meta-pill hidden">üôà Hidden</span>`
        : `<span class="meta-pill approved">‚úÖ Approved</span>`;
      return `<div class="admin-card ${isPending?'pending-card':''} ${isHidden?'hidden-card':''}" style="animation-delay:${i*.04}s">
        <div class="admin-card-meta">
          <span>üìÖ ${timeAgo(data.createdAt)}</span>
          ${statusPill}
          <span class="meta-pill">üí¨ ${data.commentCount||0}</span>
          ${ipSafe?`<span class="meta-pill">üåê ${ipSafe}</span>`:''}
        </div>
        <div class="admin-card-text">${esc(data.text)}</div>
        ${buildReactionDisplay(data.reactions)}
        <div class="admin-card-footer">
          ${isPending ? `
            <button class="btn-approve" onclick="approveConfession('${d.id}')">‚úÖ Approve</button>
            <button class="btn-danger" onclick="confirmAction('Reject Message?','This will permanently delete this message.','Reject',()=>deleteConfession('${d.id}'))">üóëÔ∏è Reject</button>
          ` : isHidden ? `
            <button class="btn-approve" onclick="toggleHide('${d.id}',false)">üëÅÔ∏è Unhide</button>
            <button class="btn-danger" onclick="confirmAction('Delete Message?','This will permanently delete this message.','Delete',()=>deleteConfession('${d.id}'))">üóëÔ∏è Delete</button>
          ` : `
            <button class="btn-danger" onclick="confirmAction('Delete Message?','This will permanently delete the message and all its comments.','Delete',()=>deleteConfession('${d.id}'))">üóëÔ∏è Delete</button>
            <button class="btn-hide" onclick="toggleHide('${d.id}',true)">üôà Hide</button>
            ${ipSafe?`<button class="btn-block" onclick="confirmAction('Block IP?','Block ${ipSafe} from submitting.','Block IP',()=>blockIP('${ipSafe}'))">üö´ Block IP</button>`:''}
            <button class="btn-expand" id="expandBtn-${d.id}" onclick="toggleComments('${d.id}')">üí¨ Comments</button>
          `}
        </div>
        ${!isPending&&!isHidden?`<div class="comments-panel" id="cpanel-${d.id}"></div>`:''}
      </div>`;
    }).join('');
  }

  window.approveConfession = async (id) => {
    try {
      await updateDoc(doc(db,'confessions',id), { status:'approved' });
      showToast('‚úÖ Message approved!');
    } catch(e){ showToast('Error approving.'); }
  };

  window.toggleHide = async (id, hide) => {
    try {
      await updateDoc(doc(db,'confessions',id), { hidden: hide });
      showToast(hide ? 'üôà Message hidden!' : 'üëÅÔ∏è Message unhidden!');
    } catch(e){ showToast('Error updating.'); }
  };

  window.filterConfessions=()=>{
    const q=document.getElementById('searchBar').value.toLowerCase();
    const approved = allDocs.filter(d=>{ const s=d.data().status; return (s==='approved'||!s)&&!d.data().hidden; });
    renderConfessions(approved.filter(d=>d.data().text.toLowerCase().includes(q)), 'confessionsList', false);
  };

  window.toggleComments=async(id)=>{
    const panel=document.getElementById('cpanel-'+id);
    const btn=document.getElementById('expandBtn-'+id);
    if(panel.classList.contains('open')){ panel.classList.remove('open'); btn.textContent='üí¨ Comments'; return; }
    panel.classList.add('open'); btn.textContent='üîº Hide';
    panel.innerHTML='<div class="loading"><div class="spinner"></div></div>';
    try {
      const snap=await getDocs(query(collection(db,'confessions',id,'comments'),orderBy('createdAt','asc')));
      if(!snap.docs.length){ panel.innerHTML='<p style="color:var(--muted);font-size:.85rem;padding:4px 0">No comments.</p>'; return; }
      panel.innerHTML=snap.docs.map(c=>{
        const cd=c.data(), cipSafe=cd.ip?esc(cd.ip):null;
        return `<div class="comment-row">
          <div class="comment-row-meta">Anonymous ¬∑ ${timeAgo(cd.createdAt)} ${cipSafe?`¬∑ üåê ${cipSafe}`:''}</div>
          <div class="comment-row-top">
            <div><div class="comment-row-text">${esc(cd.text)}</div>${buildReactionDisplay(cd.reactions)}</div>
            <div class="comment-row-actions">
              <button class="btn-danger" onclick="confirmAction('Delete Comment?','Permanently delete this comment.','Delete',()=>deleteComment('${id}','${c.id}'))">üóëÔ∏è</button>
              ${cipSafe?`<button class="btn-block" onclick="confirmAction('Block IP?','Block ${cipSafe}.','Block IP',()=>blockIP('${cipSafe}'))">üö´</button>`:''}
            </div>
          </div>
        </div>`;
      }).join('');
    } catch(e){ panel.innerHTML='<p style="color:var(--red);font-size:.85rem">Error loading.</p>'; }
  };

  window.deleteConfession=async(id)=>{
    try {
      const cSnap=await getDocs(collection(db,'confessions',id,'comments'));
      const batch=writeBatch(db);
      cSnap.docs.forEach(c=>batch.delete(doc(db,'confessions',id,'comments',c.id)));
      batch.delete(doc(db,'confessions',id));
      await batch.commit(); showToast('Message deleted ‚úÖ');
    } catch(e){ showToast('Error deleting.'); }
  };

  window.deleteComment=async(confessionId,commentId)=>{
    try {
      await deleteDoc(doc(db,'confessions',confessionId,'comments',commentId));
      toggleComments(confessionId);
      showToast('Comment deleted ‚úÖ');
    } catch(e){ showToast('Error deleting comment.'); }
  };

  window.blockIP=async(ip)=>{
    try { await setDoc(doc(db,'blockedIPs',ip.replace(/[.:]/g,'_')),{ip,blockedAt:serverTimestamp()}); showToast('IP blocked üö´'); }
    catch(e){ showToast('Error blocking IP.'); }
  };

  window.unblockIP=(docId,ip)=>{
    confirmAction('Unblock IP?',`Allow ${ip} to submit again.`,'Unblock',async()=>{
      try { await deleteDoc(doc(db,'blockedIPs',docId)); showToast('IP unblocked ‚úÖ'); }
      catch(e){ showToast('Error unblocking.'); }
    });
  };

  function renderBlocked(docs){
    const el=document.getElementById('blockedList');
    if(!docs.length){ el.innerHTML='<div class="empty">No blocked IPs üéâ</div>'; return; }
    el.innerHTML=docs.map(d=>{
      const data=d.data();
      return `<div class="blocked-card">
        <div><div class="blocked-ip">üåê ${esc(data.ip)}</div><div class="blocked-meta">Blocked ${timeAgo(data.blockedAt)}</div></div>
        <button class="btn-unblock" onclick="unblockIP('${d.id}','${esc(data.ip)}')">‚úÖ Unblock</button>
      </div>`;
    }).join('');
  }

  window.switchTab=(tab,btn)=>{
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    ['tabApproved','tabPending','tabHidden','tabBlocked'].forEach(id=>document.getElementById(id).style.display='none');
    const map = {approved:'tabApproved',pending:'tabPending',hidden:'tabHidden',blocked:'tabBlocked'};
    document.getElementById(map[tab]).style.display='block';
  };

  window.confirmAction=(title,msg,okLabel,cb)=>{
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').textContent=msg;
    document.getElementById('confirmOkBtn').textContent=okLabel;
    document.getElementById('confirmBackdrop').classList.add('open');
    confirmCb=cb;
  };
  window.closeConfirm=()=>{ document.getElementById('confirmBackdrop').classList.remove('open'); confirmCb=null; };
  document.getElementById('confirmOkBtn').onclick=async()=>{ if(confirmCb){ await confirmCb(); closeConfirm(); } };

  window.showToast=(msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800); };
</script>
</body>
</html>
